<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>PendingIntents, Dalvik, and RemoteViews</title>
  <meta name="description" content="Intro">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="objectivetruth.github.io/glympsewidget/2014/07/07/pendingintents.html">
  <link rel="alternate" type="application/rss+xml" title="Nothing but the Objectivetruth" href="objectivetruth.github.io/feed.xml" />
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Nothing but the Objectivetruth</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">PendingIntents, Dalvik, and RemoteViews</h1>
    <p class="post-meta">Jul 7, 2014</p>
  </header>

  <article class="post-content">
    <h2>Intro</h2>

<p>I&#39;m almost at the end of making the widget, but I&#39;m going back to some
things I&#39;ve learned on my way. Also, I&#39;m hoping to get access to the
glympse inner workings to make the widget even better but that&#39;s to come
later.</p>

<h2>Widget, Remote Views and Dalvik</h2>

<p>First things you must understand:</p>

<p>Dalvik is the Android Virtual Machine. It basically handles your
code when it executes.</p>

<p>Each application is given its own process that it can manage. Normally
all your code for a simple app runs in its own process (example:
com.objectivetruth.uoitdcbooking).</p>

<p>HOWEVER, widgets are a bit different. The code executes in your own
process (com.objectivetruth.glympsewidget in my case) BUT the VIEW is
handled by the Home Screen Process or Lock Screen Process
(depending where the widget resides).</p>

<p>Now, for security reasons you can&#39;t access things that are part of
another process. This is good, but we have to find a way around it...</p>

<p>When you want to update your Widget&#39;s View you need to use a
RemoteView</p>

<p>RemoteViews are NOT Views. They are a set of configurations and
functions that execute the request on your behalf.
 Example:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">//Getting instance of the AppWidgetManager who will actually change the</span>
<span class="c1">//view on your behalf.</span>
<span class="n">AppWidgetManager</span> <span class="n">appWidgetManager</span> <span class="o">=</span> <span class="n">AppWidgetManager</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
<span class="c1">//Create a RemoteView targeting your Widget&#39;s Layout</span>
<span class="n">RemoteViews</span> <span class="n">views</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">RemoteViews</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getPackageName</span><span class="o">(),</span> <span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">main</span><span class="o">);</span>
<span class="c1">//RemoteViews has a set of commands for common view requests</span>
<span class="c1">//Here, we are changing the Text of a TextView in the R.layout.main layout</span>
<span class="n">views</span><span class="o">.</span><span class="na">setTextViewText</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">textview1</span><span class="o">,</span> <span class="s">&quot;updated text&quot;</span><span class="o">);</span>
<span class="c1">//Because the View doesn&#39;t belong to your process you need the App Widget</span>
<span class="c1">//Manager to do it on your behalf</span>
<span class="n">appWidgetManager</span><span class="o">.</span><span class="na">updateAppWidget</span><span class="o">(</span><span class="n">appWidgetId</span><span class="o">,</span> <span class="n">views</span><span class="o">);</span>
</code></pre></div>
<h2>PendingIntents and Broadcasts</h2>

<p>First, why would you use this?</p>

<p>These are Implicit Intents are are used when you want a widget to send a message to itself. Such as a button click to have the widget launch a webpage. More on this in the next post. (Big topic). OnClickListener is a perfect example of all of this.  </p>

<p>Usage PendingIntents&gt; are intents that are executed on your behalf. They basically allow you to temporarily give another process permission to use your code. This has to do with the above because Dalvik doesn&#39;t let other apps do things to your apps unless you authorize it, hence PendingIntents are born.
 
Best analogy I can think of is customs paperwork for a car being transported</p>

<p>The paperwork (PendingIntent) allows other processes to execute/use your Intent(the car). The car(your Intent) won&#39;t be able to go with anyone unless they have paperwork (PendingIntent) attached.</p>

<p>You get a PendingIntent by calling getBroadCast(). This is like looking through all the filling cabinets at the customs office to see if that paperwork has already been done. If it has, then just get an instance of it, otherwise create a new one.</p>

<p>This is very important when working with multiple remote views or multiple widget instances (this will be in another post...). For now we&#39;re working with 1 widget.
 
The below code illustrates Broadcast, pending intents nicely when you want to setOnClick behavior for a RemoteView such as a widget to update itself.</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">//Create an Intent as normal with the action being something you can</span>
<span class="c1">//catch later in the appropriate activity, more on that below.</span>
<span class="c1">//I suggest using something unique such as com.my.packagename.action</span>
<span class="n">Intent</span> <span class="n">myIntent</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Intent</span><span class="o">(</span><span class="s">&quot;com.my.packagename.action&quot;</span><span class="o">);</span>
<span class="c1">//Create a PendingIntent by calling getBroadcast</span>
<span class="n">PendingIntent</span> <span class="n">pendingClearScreenIntent</span> <span class="o">=</span> <span class="n">PendingIntent</span><span class="o">.</span><span class="na">getBroadcast</span>
    <span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">clearScreenIntent</span><span class="o">,</span> <span class="n">PendingIntent</span><span class="o">.</span><span class="na">FLAG_UPDATE_CURRENT</span><span class="o">);</span>
<span class="c1">//RemoteView created earlier</span>
<span class="n">views</span><span class="o">.</span><span class="na">setOnClickPendingIntent</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">clearbutton</span><span class="o">,</span> <span class="n">pendingClearScreenIntent</span><span class="o">);</span>
<span class="c1">//then pass off the RemoteView to the AppWidgetManager&lt;/pre&gt;</span>
</code></pre></div>
<h2>Catching the PendingIntent</h2>

<p>In the android manifest here is where you catch the PendingIntent and send it to the AppWidgetProvider</p>
<div class="highlight"><pre><code class="language-xml" data-lang="xml">    android:name=&quot;.ApplicationGlympseWidget&quot;
    android:icon=&quot;@drawable/ic_launcher&quot;
    android:label=&quot;@string/app_name&quot;
    android:theme=&quot;@style/AppTheme&quot; &gt;



        <span class="nt">&lt;/intent-filter&gt;</span>

            android:resource=&quot;@xml/widget_info&quot;/&gt;
    <span class="nt">&lt;/receiver&gt;</span>
</code></pre></div>
<p> 
I&#39;ll write a whole post on AppWidgetProvider but here&#39;s a great starter tutorial to get you up to speed</p>

<p><a href="http://www.youtube.com/watch?v=p_ZjPb_opVQE"><img src="http://img.youtube.com/vi/p_ZjPb_opVQ/0.jpg" alt=""></a></p>

  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Nothing but the Objectivetruth</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Nothing but the Objectivetruth</li>
          <li><a href="mailto:miguel@objectivetruth.ca">miguel@objectivetruth.ca</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/Objectivetruth">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">Objectivetruth</span>
            </a>
          </li>
          

          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">Musing from a mature student with a background in Sales, Biosciences and now Computer Science. Trying to save the world one app at a time.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
